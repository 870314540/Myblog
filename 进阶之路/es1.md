ES基础之一


###简介

ES：Elasticsearch（elastic + search） 

ElasticSearch是一个基于Lucene的开源搜索引擎。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口.

Elasticsearch是面向文档(document oriented)的。在Elasticsearch中，你可以对文档（而非成行成列的数据）进行索引、搜索、排序、过滤。


Elastic Search是一个实时的高可用的分布式全文搜索和分析引擎，它可以快速地对PB级的数据进行搜索、分析、快速返回结果；它是建立在全文搜索引擎Lucene基础上的搜索引擎，提供多种语言的API，使用简单，可以方便快捷地进行扩容以满足不断增长的业务数据需求。
         
分片 复制  冗余 


         
与传统数据库比较：

	Relational DB -> Databases -> Tables -> Rows      -> Columns
	Elasticsearch -> Indices   -> Types  -> Documents -> Fields

###基本概念

- 接近实时搜索 NRT 

- 集群  节点

群集是一个或多个节点（服务器）的集合，它们共同保存您的整个数据，并提供跨所有节点的联合索引和搜索功能。群集由唯一名称标识

节点是属于集群一部分的单个服务器。它存储数据并参与群集索引和搜索功能。

一个运行中的 Elasticsearch 实例称为一个 节点，

集群是由一个或者多个拥有相同 cluster.name 配置的节点组成， 它们共同承担数据和负载的压力。当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。

- 索引 index

索引就像关系数据库中的“数据库”。它有一个定义多种类型的映射。索引是逻辑名称空间，映射到一个或多个主分片，并且可以有零个或多个副本分片。


- 类型 type

类型是索引的逻辑类别/分区，

- 分片和复制 

主分片 复制分片

默认情况下，Elasticsearch中的每个索引被分片`5个主分片和1个复制`，这意味着，如果你的集群中至少有两个节点，你的索引将会有5个主分片和另外5个复制分片（1个完全拷贝），这样的话每个索引总共就有10个分片。

<b>分片很重要，主要有两方面的原因： 
1）允许你水平分割/扩展你的内容容量。 
2）允许你在分片（潜在地，位于多个节点上）之上进行分布式的、并行的操作，进而提高性能/吞吐量。</b>

一个分片可以是 主 分片或者 副本 分片。 索引内任意一个文档都归属于一个主分片，所以主分片的数目决定着索引能够保存的最大数据量。


###集群内容

- 集群健康

status 字段中展示为 green 、 yellow（主分片全部正常，副本分片不正常） 或者 red

`curl XGET Http://localhost:9200/_cluster/health`

put /index/_settings 动态调整副本分片数目


###输入和输出

在 Elasticsearch 中 文档是指最顶层或者根对象, 这个根对象被序列化成 JSON 并存储到 Elasticsearch 中，指定了唯一 ID。

元数据元素： _index,_type,_id

`PUT /{index}/{type}/{id}`
`POST /{index}/{type}  缺省id,系统自动帮助创建`

> 1.索引名:名字必须小写，不能以下划线开头，不能包含逗号.
> 2._type :可以是大写或者小写，但是不能以下划线或者句号开头,不应该包含逗号,并且长度限制为256个字符.
> 3.自动生成的 ID 是 URL-safe、 基于 Base64 编码且长度为20个字符的 GUID 字符串


获取部分文档url：
`/website/blog/123?_source=title,text`

只需source里字段
`/website/blog/123/_source`


在 Elasticsearch 中文档是 不可改变 的，不能修改它们。 相反，如果想要更新现有的文档，需要 重建索引 或者进行替换

在内部，Elasticsearch 已将旧文档标记为已删除，并增加一个全新的文档。 尽管你不能再对旧版本的文档进行访问，但它并不会立即消失。当继续索引更多的数据，Elasticsearch 会在后台清理这些已删除文档。
（标记后，内部后台清理）



### 分布式文档存储

路由一个文档到分片  `shard = hash(routing) % number_of_primary_shards`

主分片与副本分片交互

当发送请求的时候， 为了扩展负载，更好的做法是轮询集群中所有的节点。

协调节点

一致性保证



### mapping ：

类似于数据类型，组成有analyzer，filter

mapping的作用就是执行一系列的指令将输入的数据转成可搜索的索引项




###倒排索引

倒排索引(Inverted Index)：倒排索引是实现“单词-文档矩阵”的一种具体存储形式，通过倒排索引，可以根据单词快速获取包含这个单词的文档列表。倒排索引主要由两个部分组成：“单词词典”和“倒排文件”。








1、问题

如何存储

如何分片

如何启动 相应


如何分词索引

分片故障 如何处理



---

5.*之后，把string字段设置为了过时字段，引入text，keyword字段

这两个字段都可以存储字符串使用，但建立索引和搜索的时候是不太一样的

keyword：存储数据时候，不会分词建立索引

text：存储数据时候，会自动分词，并生成索引（这是很智能的，但在有些字段里面是没用的，所以对于有些字段使用text则浪费了空间）。

--- 

JestClient 操作 es 





参考：
[es 参考1](https://mp.weixin.qq.com/s/XEYsgYOcI7Wv0PZq4Sf-Hw)